
### split Parksmap source code ###

# create repo for RHOCP templates and other files used for this project
cd $HOME

git clone https://github.com/mcdmike74/rhocp-adv-dev
source <(oc completion bash)

# BUILD JEKINS SLAVE IMAGE (add skopeo and apb pkgs)
# execute on laptop or OpenShift Client VM
mkdir $HOME/jenkins-slave-maven-appdev
cd $HOME/jenkins-slave-maven-appdev

cat > Dockerfile << "EOF"
FROM docker.io/openshift/jenkins-slave-maven-centos7:v3.9
USER root
RUN yum -y install skopeo apb && \
    yum clean all
USER 1001
EOF

docker build . -t mcdmike74/jenkins-slave-maven-appdev:v3.9
docker push mcdmike74/jenkins-slave-maven-appdev:v3.9
docker tag mcdmike74/jenkins-slave-maven-appdev:v3.9 mcdmike74/jenkins-slave-maven-appdev:latest

cd $HOME/rhocp-adv-dev
oc login master.na39.openshift.opentlc.com --username="mmcdonough-stonedoorgroup.com" --password="XYZ"


### Gogs ###
oc new-project gogs --display-name="Shared Gogs"
oc process -f gogs_template.yaml \
	-p GOGS_VERSION=latest \
	-p HOSTNAME=gogs.$(oc project --short=true)-shared.apps.na39.openshift.opentlc.com | oc create -f -

# wait until deployment completes, then continue
oc get routes

# note URL for routes/gogs
# open gogs route URL in browser, create admin user by creating first account (click "Register")
# create new Organization "RHOCPAD" using gogs web UI

cd $HOME
git clone https://github.com/wkulhanek/ParksMap.git
cd $HOME/ParksMap
for i in mlbparks nationalparks parksmap; do ln nexus_settings.xml $i; done
for i in mlbparks nationalparks parksmap; do ln nexus_settings_openshift.xml $i; done
for i in mlbparks nationalparks parksmap; do ln .gitmore $i; done
cd $HOME/ParksMap/mlbparks
git init
git add .
git commit -a
git remote add origin http://gogs.gogs-shared.apps.na39.openshift.opentlc.com/RHOCPAD/mlbparks.git
git push -u origin master
cd $HOME/ParksMap/nationalparks
git init
git add .
git commit -a
git remote add origin http://gogs.gogs-shared.apps.na39.openshift.opentlc.com/RHOCPAD/nationalparks.git
git push -u origin master
cd $HOME/ParksMap/parksmap
git init
git add .
git commit -a
git push -u origin master
git remote add origin http://gogs.gogs-shared.apps.na39.openshift.opentlc.com/RHOCPAD/parksmap.git
git push -u origin master


### Nexus ###
oc new-project nexus3 --display-name="Shared Nexus"
oc process -f nexus3_template.yaml \
	-p HOSTNAME=nexus3.$(oc project --short=true)-shared.apps.na39.openshift.opentlc.com \
	-p APPLICATION_NAME=nexus3 | oc create -f -


### SonarQube ###
oc new-project sonarqube --display-name="Shared SonarQube"
oc process -f sonarqube_template.yaml \
	-p HOSTNAME=sonar.$(oc project --short=true)-shared.apps.na39.openshift.opentlc.com \
	-p SONARQUBE_VERSION=latest | oc create -f -


### JENKINS ###
oc new-project jenkins --display-name "Shared Jenkins"
oc process -f jenkins_template.yaml \
	-p HOSTNAME=jenkins.$(oc project --short=true)-shared.apps.na39.openshift.opentlc.com \
	-p PROJECT=jenkins | oc create -f -


### APPLICATION - DEVELOPMENT ###
# create project for ParksMap development instance
oc new-project parksmap-dev --display-name="ParksMap Development"
oc create secret generic gogs-secret --from-literal=username=mmcdonough --from-literal=password=B0bfIshk1ns
oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n parksmap-dev

oc new-app mongodb-persistent -p MONGODB_PASSWORD=mongodb_password -p MONGODB_DATABASE=parksmap

oc process -f mlbparks-template-eap-no-mongo-dev.yaml -p CONTEXT_DIR=/mlbparks \
	-p GIT_URI=http://gogs.gogs.svc.cluster.local:3000/CICDLabs/ParksMap.git \
	-p MAVEN_MIRROR_URL=http://nexus3.nexus.svc.cluster.local:8081/repository/maven-public/ | oc create -f -
oc create configmap mlbparks-config --from-literal="application-users.properties=Placeholder" --from-literal="application-roles.properties=Placeholder" -n parksmap-dev
oc set volume dc/mlbparks --add --name=jboss-config --mount-path=/opt/eap/standalone/configuration/application-users.properties --sub-path=application-users.properties --configmap-name=tasks-config -n parksmap-dev
oc set volume dc/mlbparks --add --name=jboss-config1 --mount-path=/opt/eap/standalone/configuration/application-roles.properties --sub-path=application-roles.properties --configmap-name=tasks-config -n parksmap-dev

oc set build-secret --source bc/tasks gogs-secret


### APPLICATION - PRODCUTION ###
# create project for ParksMap production instance
oc new-project parksmap-prod --display-name="ParksMap Production"
oc create secret generic gogs-secret --from-literal=username=mmcdonough --from-literal=password=B0bfIshk1ns
oc policy add-role-to-user edit system:serviceaccount:jenkins:jenkins -n parksmap-prod

# instantiate MongoDB statefulSet with 3 replicas
oc create -f mongodb_stateful_set.yaml
